version: "3.8"

services:
  # Aether Vault CLI Orchestrator
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aether-vault-orchestrator
    privileged: true # Required for Docker-in-Docker to manage other containers
    volumes:
      # Mount Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount compose files from subdirectories
      - ./web/docker-compose.yml:/app/web-compose.yml:ro
      - ./server/docker-compose.yml:/app/server-compose.yml:ro
      # Shared network and volumes
      - aether-vault-data:/app/shared-data
    ports:
      - "3000:3000" # Web interface
      - "8080:8080" # API server
      - "5432:5432" # PostgreSQL (optional external access)
      - "6379:6379" # Redis (optional external access)
    networks:
      - aether-vault-network
    restart: unless-stopped
    environment:
      - COMPOSE_PROJECT_NAME=aether-vault
      - DOCKER_HOST=unix:///var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: CLI management interface
  cli-management:
    image: docker:24-alpine
    container_name: aether-vault-cli-management
    depends_on:
      orchestrator:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - aether-vault-network
    working_dir: /app
    command: >
      sh -c "
        echo 'ðŸ”§ Aether Vault CLI Management Interface';
        echo 'Available commands:';
        echo '  docker-compose -f /app/server-compose.yml ps - Show server services';
        echo '  docker-compose -f /app/web-compose.yml ps - Show web services';
        echo '  docker-compose -f /app/server-compose.yml logs -f - Show server logs';
        echo '  docker-compose -f /app/web-compose.yml logs -f - Show web logs';
        echo '  docker-compose -f /app/server-compose.yml restart - Restart server services';
        echo '  docker-compose -f /app/web-compose.yml restart - Restart web services';
        echo '';
        echo 'Press Ctrl+C to exit';
        tail -f /dev/null
      "
    profiles:
      - management

volumes:
  aether-vault-data:
    driver: local

networks:
  aether-vault-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
