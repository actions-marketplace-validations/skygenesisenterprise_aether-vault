// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USER MANAGEMENT
// ========================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  passwordHash    String    @map("password") @db.Text
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  isActive        Boolean   @default(true) @map("is_active")
  avatar          String?
  phone           String?
  locale          String    @default("en")
  timezone        String    @default("UTC")
  emailVerified   Boolean   @default(false) @map("email_verified")
  lastLoginAt     DateTime? @map("last_login_at")
  passwordChangedAt DateTime? @map("password_changed_at")
  twoFactorEnabled Boolean  @default(false) @map("two_factor_enabled")
  
  // Relationships
  secrets         Secret[]
  totps           TOTP[]
  policies         Policy[]
  sessions        Session[]
  auditLogs       AuditLog[]
  organizations   OrganizationMember[]
  emergencyAccess  EmergencyAccess[] @relation("EmergencyAccessForUser")
  emergencyAccessTo EmergencyAccess[] @relation("EmergencyAccessByUser")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  isActive  Boolean  @default(true) @map("is_active")
  
  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("sessions")
}

// ========================================
// SECRET MANAGEMENT
// ========================================

model Secret {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  name         String
  description  String?
  value        String    @db.Text
  valueHash    String    @db.Text @map("value_hash")
  type         SecretType
  tags         String?   @db.Text
  url          String?
  username     String?
  notes        String?   @db.Text
  expiresAt    DateTime? @map("expires_at")
  lastAccessAt DateTime? @map("last_access_at")
  isActive     Boolean   @default(true) @map("is_active")
  isFavorite    Boolean   @default(false) @map("is_favorite")
  
  // Relationships
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder         Folder?         @relation(fields: [folderId], references: [id], onDelete: SetNull)
  attachments   SecretAttachment[]
  shares        SecretShare[]
  accessLogs     SecretAccessLog[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("secrets")
}

model Folder {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  description String?
  color       String?  @default("#3B82F6")
  icon        String?  @default("folder")
  parentId    String?  @map("parent_id")
  
  // Relationships
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Folder?   @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Folder[]  @relation("FolderHierarchy")
  secrets     Secret[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("folders")
}

model SecretAttachment {
  id       String @id @default(cuid())
  secretId String @map("secret_id")
  fileName String @map("file_name")
  fileSize BigInt @map("file_size")
  mimeType String @map("mime_type")
  filePath String @map("file_path")
  
  // Relationships
  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("secret_attachments")
}

model SecretShare {
  id           String      @id @default(cuid())
  secretId     String      @map("secret_id")
  sharedBy     String      @map("shared_by")
  sharedTo     String?     @map("shared_to")
  shareType    ShareType   @map("share_type")
  expiresAt    DateTime?   @map("expires_at")
  maxAccess    Int?        @map("max_access")
  currentCount Int         @default(0) @map("current_count")
  password     String?     @db.Text
  isActive     Boolean     @default(true) @map("is_active")
  
  // Relationships
  secret   Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)
  sharer   User    @relation("SecretShares", fields: [sharedBy], references: [id])
  receiver User?   @relation("SecretReceived", fields: [sharedTo], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("secret_shares")
}

model SecretAccessLog {
  id        String   @id @default(cuid())
  secretId  String   @map("secret_id")
  userId    String?  @map("user_id")
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent")
  action    String
  success   Boolean  @default(true)
  
  // Relationships
  secret Secret @relation(fields: [secretId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("secret_access_logs")
}

// ========================================
// TWO-FACTOR AUTHENTICATION (TOTP)
// ========================================

model TOTP {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  description String?
  secret      String   @db.Text
  algorithm   String   @default("SHA1")
  digits      Int      @default(6)
  period      Int      @default(30)
  qrCode      String?  @map("qr_code") @db.Text
  backupCodes String?  @map("backup_codes") @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  
  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("totps")
}

// ========================================
// ORGANIZATION MANAGEMENT
// ========================================

model Organization {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?
  logo            String?
  domain          String?
  isPublic        Boolean   @default(false) @map("is_public")
  maxUsers        Int?      @map("max_users")
  maxSecrets     Int?      @map("max_secrets")
  seatLimit       Int?      @map("seat_limit")
  subscriptionPlan String?  @map("subscription_plan")
  billingEmail    String?   @map("billing_email")
  settings        Json?     @default("{}")
  
  // Relationships
  members   OrganizationMember[]
  policies  OrganizationPolicy[]
  invites   OrganizationInvite[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("organizations")
}

model OrganizationMember {
  id            String             @id @default(cuid())
  organizationId String             @map("organization_id")
  userId        String             @map("user_id")
  role          OrganizationRole
  status        MemberStatus        @default("pending")
  permissions   Json?              @default("[]")
  invitedBy     String?            @map("invited_by")
  joinedAt      DateTime?          @map("joined_at")
  lastAccessAt   DateTime?          @map("last_access_at")
  
  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter       User?            @relation("OrganizationInvites", fields: [invitedBy], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([organizationId, userId])
  @@map("organization_members")
}

model OrganizationPolicy {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  name           String
  description    String?
  type           PolicyType
  rules          Json       @default("{}")
  isActive       Boolean   @default(true) @map("is_active")
  priority       Int       @default(0)
  applyToAll    Boolean   @default(false) @map("apply_to_all")
  
  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        OrganizationMember[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("organization_policies")
}

model OrganizationInvite {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  invitedEmail   String        @map("invited_email")
  invitedBy      String        @map("invited_by")
  role           OrganizationRole
  token          String        @unique
  expiresAt       DateTime      @map("expires_at")
  status         InviteStatus  @default("pending")
  message        String?       @db.Text
  
  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter       User         @relation("OrganizationInvites", fields: [invitedBy], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("organization_invites")
}

// ========================================
// SECURITY & AUDIT
// ========================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  resource   String?
  resourceId String?  @map("resource_id")
  ipAddress  String   @map("ip_address")
  userAgent  String?  @map("user_agent") @db.Text
  success    Boolean  @default(true)
  details    Json?    @default("{}")
  
  // Relationships
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("audit_logs")
}

model SecurityEvent {
  id        String   @id @default(cuid())
  type      SecurityEventType
  severity  EventSeverity
  title     String
  description String?  @db.Text
  userId    String?  @map("user_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  details   Json?    @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  resolvedAt DateTime? @map("resolved_at")
  resolvedBy String?  @map("resolved_by")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("security_events")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  success   Boolean
  failureReason String? @map("failure_reason")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("login_attempts")
}

// ========================================
// POLICY MANAGEMENT
// ========================================

model Policy {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  description String?
  type        PolicyType
  rules       Json       @default("{}")
  isActive    Boolean   @default(true) @map("is_active")
  priority    Int       @default(0)
  
  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("policies")
}

// ========================================
// SENDS (SECURE SHARING)
// ========================================

model Send {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  type         SendType
  name         String
  text         String?    @db.Text
  filePath     String?    @map("file_path")
  fileName     String?    @map("file_name")
  fileSize     BigInt?    @map("file_size")
  mimeType     String?    @map("mime_type")
  password     String?    @db.Text
  maxAccess    Int?       @map("max_access")
  currentCount Int        @default(0) @map("current_count")
  expiresAt    DateTime?  @map("expires_at")
  deletionDate DateTime?  @map("deletion_date")
  isActive    Boolean    @default(true) @map("is_active")
  accessKey    String     @unique @map("access_key")
  
  // Relationships
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessLogs  SendAccessLog[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  
  @@map("sends")
}

model SendAccessLog {
  id        String   @id @default(cuid())
  sendId    String   @map("send_id")
  ipAddress String   @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  success   Boolean  @default(true)
  
  // Relationships
  send Send @relation(fields: [sendId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("send_access_logs")
}

// ========================================
// EMERGENCY ACCESS
// ========================================

model EmergencyAccess {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  emergencyUserId  String            @map("emergency_user_id")
  status           EmergencyStatus    @default("pending")
  waitTimeHours    Int               @default(48) @map("wait_time_hours")
  requestedAt      DateTime          @map("requested_at")
  approvedAt       DateTime?         @map("approved_at")
  lastAccessAt     DateTime?         @map("last_access_at")
  accessCount      Int               @default(0) @map("access_count")
  maxAccessCount  Int?              @map("max_access_count")
  expiresAt        DateTime?         @map("expires_at")
  isActive         Boolean           @default(true) @map("is_active")
  
  // Relationships
  user           User  @relation("EmergencyAccessForUser", fields: [userId], references: [id], onDelete: Cascade)
  emergencyUser  User  @relation("EmergencyAccessByUser", fields: [emergencyUserId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("emergency_access")
}

// ========================================
// ENUMS
// ========================================

enum SecretType {
  password
  api_key
  token
  certificate
  secure_note
  credit_card
  identity
  other
}

enum ShareType {
  link
  email
  user
  organization
}

enum OrganizationRole {
  owner
  admin
  manager
  member
  viewer
}

enum MemberStatus {
  pending
  active
  suspended
  removed
}

enum PolicyType {
  password_policy
  access_policy
  sharing_policy
  security_policy
  retention_policy
}

enum InviteStatus {
  pending
  accepted
  declined
  expired
  revoked
}

enum SecurityEventType {
  login_failure
  suspicious_login
  password_change
  two_factor_disabled
  account_locked
  data_breach
  unusual_activity
  security_scan
}

enum EventSeverity {
  low
  medium
  high
  critical
}

enum EmergencyStatus {
  pending
  approved
  rejected
  expired
  revoked
  active
}

enum SendType {
  text
  file
}